<!DOCTYPE html>
<html lang="pl" x-data>
<head>
    <meta charset="UTF-8"/>
    <title>{{ title or "LLM-router Model Configurator" }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <!-- Common styles (independent of theme) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Themeâ€‘specific stylesheet â€“ will be swapped by the toggle button -->
    <link id="theme-link" rel="stylesheet"
          href="{{ url_for('static', filename='style-dark.css') }}">
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body>
<header class="topbar">
    <h1 class="logo"><a href="{{ url_for('index') }}">LLM-router Model Configurator</a></h1>
    <nav class="menu">
        {% if session.get('user_id') %}
        <div class="dropdown" x-data="{ open: false }">
            <button type="button"
                    class="btn btn-tile"
                    @click="open = !open"
                    @keydown.escape.window="open = false">
                Project: {{ current_project_name }}
            </button>

            <div class="dropdown-content"
                 x-show="open"
                 @click.outside="open = false">

                <div class="panel">
                    <div class="label">Choose project</div>

                    {% for proj in user_projects %}
                    <form method="post" action="{{ url_for('select_project', project_id=proj.id) }}" style="margin:0;">
                        <button type="submit"
                                class="btn btn-small{% if proj.id == session.get('project_id') %} active{% endif %}">
                            {{ proj.name }}
                        </button>
                    </form>
                    {% endfor %}
                </div>
                <a class="btn btn-small" href="{{ url_for('manage_projects') }}">Manage projects</a>
            </div>
        </div>

        <span class="spacer"></span>

        <div class="dropdown" x-data="{ open: false }">
            <button type="button"
                    class="btn btn-tile{% if config_active %} active{% endif %}"
                    @click="open = !open"
                    @keydown.escape.window="open = false">
                Manage configs
            </button>

            <div class="dropdown-content"
                 x-show="open"
                 @click.outside="open = false">
                <a class="btn btn-small{% if request.endpoint == 'new_config' %} active{% endif %}"
                   href="{{ url_for('new_config') }}">New config (from scratch)</a>

                <a class="btn btn-small{% if request.endpoint == 'import_config' %} active{% endif %}"
                   href="{{ url_for('import_config') }}">Load config (from JSON)</a>

                <a class="btn btn-small{% if request.endpoint == 'list_configs' %} active{% endif %}"
                   href="{{ url_for('list_configs') }}">Show all defined configs</a>
            </div>
        </div>

        {% if session.get('role') == 'admin' %}
        <div class="dropdown" x-data="{ open: false }">
            <button type="button"
                    class="btn btn-tile"
                    @click="open = !open"
                    @keydown.escape.window="open = false">
                Manage users
            </button>

            <div class="dropdown-content"
                 x-show="open"
                 @click.outside="open = false">
                <a class="btn btn-small"
                   href="{{ url_for('admin_users') }}">Manage users</a>
            </div>
        </div>
        {% endif %}

        <span class="spacer"></span>

        <!-- Settings dropdown -->
        <div class="dropdown" x-data="{ open: false }">
            <button type="button" class="btn btn-tile"
                    @click="open = !open"
                    @keydown.escape.window="open = false">
                <span aria-hidden="true">âš™ï¸</span> Settings
            </button>
            <div class="dropdown-content"
                 x-show="open"
                 @click.outside="open = false">

                <div class="panel">
                    <label>Theme</label>
                    <select id="theme-select" title="Wybierz motyw">
                        <option value="dark">ğŸŒ™ Dark</option>
                        <option value="light">â˜€ï¸ Light</option>
                        <option value="hacker">ğŸ’» Hacker</option>
                    </select>
                </div>

                <div class="panel">
                    <label>User</label>

                    <a class="btn btn-small" href="{{ url_for('change_password') }}"
                       style="background:var(--ok);color:#fff;">
                        <span aria-hidden="true" style="margin-right:4px;">ğŸ”’</span>Change password
                    </a>

                    <a id="logout-btn" class="btn btn-small danger"
                       href="{{ url_for('logout') }}" title="Logout">ğŸšª Logout user {{ session.get('username') }}</a>
                </div>
            </div>
        </div>

        <span class="spacer"></span>

        {% endif %}
    </nav>
</header>

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
<div class="flash-container">
    {% for category, message in messages %}
    <div class="flash {{ category }}">{{ message }}</div>
    {% endfor %}
</div>
{% endif %}
{% endwith %}

<main class="container">
    {% block content %}{% endblock %}
</main>

<script>
    (function () {
        const themeLink = document.getElementById('theme-link');
        const themeSelect = document.getElementById('theme-select');

        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        let currentTheme = savedTheme || (prefersDark ? 'dark' : 'light');

        const setTheme = (theme) => {
            if (theme === 'dark') {
                themeLink.href = "{{ url_for('static', filename='style-dark.css') }}";
            } else if (theme === 'light') {
                themeLink.href = "{{ url_for('static', filename='style-light.css') }}";
            } else if (theme === 'hacker') {
                themeLink.href = "{{ url_for('static', filename='style-hacker.css') }}";
            }
            localStorage.setItem('theme', theme);
            currentTheme = theme;
            themeSelect.value = theme;
        };

        setTheme(currentTheme);

        themeSelect.addEventListener('change', (e) => {
            setTheme(e.target.value);
        });

        window.matchMedia('(prefers-color-scheme: dark)')
            .addEventListener('change', e => {
                if (!localStorage.getItem('theme')) {
                    setTheme(e.matches ? 'dark' : 'light');
                }
            });
    })();
</script>

</body>
</html>