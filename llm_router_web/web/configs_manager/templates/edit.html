{% extends "base.html" %}
{% block content %}
<div x-data="{ editing: false, name: '{{ cfg.name }}' }" class="form-inline edit-header">
    <template x-if="!editing">
        <div class="form-inline edit-header">
            <h2>You are editing config: <code x-text="name"></code></h2>
            <button type="button" class="btn btn-small" @click="editing = true">Rename</button>
        </div>
    </template>
    <template x-if="editing">
        <form method="post" class="form-inline edit-header">
            <input type="text" name="new_name" x-model="name" required class="col-input">
            <button class="btn btn-small" type="submit">Save</button>
            <button type="button" class="btn btn-small btn-secondary" @click="editing = false">Cancel</button>
        </form>
    </template>
</div>

<!-- -------------------------------------------------
     New: optional description (Notatka/Opis) for the config
--------------------------------------------------- -->
<form method="post" class="form">
    <label>Additional config info (optional)
        <textarea name="description" rows="3"
                  placeholder="Put config description here...">{{ cfg.description }}</textarea>
    </label>

    <h3>Active Models</h3>
    <div class="grid active-models">
        {% for fam, models in families.items() %}
        <div class="panel">
            <h4>{{ fam }}</h4>
            <select name="{{ fam }}[]" multiple size="6" class="w100">
                {% for m in models %}
                <option value="{{ m.name }}" {% if m.name in actives[fam] %}selected{% endif %}>{{ m.name }}</option>
                {% endfor %}
            </select>
        </div>
        {% endfor %}
    </div>

    <label>Changelog (optional)
        <input type="text" name="note" placeholder="e.g. weight changes, provider added">
    </label>

    <div class="form-actions">
        <button class="btn" type="submit">Save changes</button>
        <a class="btn btn-secondary" href="{{ url_for('view_config', config_id=cfg.id) }}">Preview</a>
    </div>
</form>

<hr class="model-divider">

<h3>Models and providers</h3>

<div class="grid">
    {% for fam, models in families.items() %}
    <section class="panel">
        <div class="panel-header">
            <h4>{{ fam }}</h4>
        </div>
        <form hx-post="{{ url_for('add_model', config_id=cfg.id) }}" hx-trigger="submit"
              hx-swap="none"
              hx-on="htmx:afterRequest: location.reload()"
              class="add-model-form">
            <input type="hidden" name="family" value="{{ fam }}">
            <input type="text" name="name" placeholder="Model name (e.g. google/gemma-3-12b-it)" required>
            <button class="btn btn-small" type="submit">Add model</button>
        </form>

        <hr class="model-separator">

        {% for m in models %}
        <details class="model">
            <summary>
                <strong>{{ m.name }}</strong>
                <button class="btn btn-small danger"
                        hx-post="{{ url_for('delete_model', model_id=m.id) }}"
                        hx-swap="none"
                        hx-on="htmx:afterRequest: location.reload()"
                        hx-confirm="Are you sure to delete {{ m.name }}?">Delete
                </button>
            </summary>

            <div class="scroll-wrap">
                <table class="table">
                    <thead>
                    <tr>
                        <th class="col-id">ID</th>
                        <th class="col-host">Host</th>
                        <th class="col-api">Provider</th>
                        <th class="col-input">Input</th>
                        <th>Model path/name</th>
                        <th class="col-weight">Weight</th>
                        <th>Token</th>
                        <th class="col-enabled">Active</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody data-model-id="{{ m.id }}">
                    {% for p in m.providers|sort(attribute='order') %}
                    <tr x-data="{ masked: true }"
                        data-provider-id="{{ p.id }}"
                        draggable="true">
                        <td class="col-id">
                            <input value="{{ p.provider_id }}"
                                   @change="fetch('{{ url_for('update_provider', provider_id=p.id) }}',
                                 {method:'POST',headers:{'Content-Type':'application/json'},
                                  body:JSON.stringify({provider_id:$event.target.value})})">
                        </td>
                        <td class="col-host">
                            <input value="{{ p.api_host }}"
                                   @change="fetch('{{ url_for('update_provider', provider_id=p.id) }}',
                                 {method:'POST',headers:{'Content-Type':'application/json'},
                                  body:JSON.stringify({api_host:$event.target.value})})">
                        </td>
                        <td class="col-api">
                            <select
                                    @change="fetch('{{ url_for('update_provider', provider_id=p.id) }}',
                                {method:'POST',headers:{'Content-Type':'application/json'},
                                 body:JSON.stringify({api_type:$event.target.value})})">
                                {% for t in ['vllm','openai','ollama', 'llmstudio'] %}
                                <option value="{{ t }}" {% if p.api_type== t %}selected{% endif %}>{{ t }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class="col-input">
                            <input type="number" min="1" value="{{ p.input_size }}"
                                   @change="fetch('{{ url_for('update_provider', provider_id=p.id) }}',
                                 {method:'POST',headers:{'Content-Type':'application/json'},
                                  body:JSON.stringify({input_size:parseInt($event.target.value)})})">
                        </td>
                        <td>
                            <input value="{{ p.model_path or '' }}"
                                   @change="fetch('{{ url_for('update_provider', provider_id=p.id) }}',
                                 {method:'POST',headers:{'Content-Type':'application/json'},
                                  body:JSON.stringify({model_path:$event.target.value})})">
                        </td>
                        <td class="col-weight">
                            <input type="number" step="0.01" min="0" max="1" value="{{ '%.2f'|format(p.weight) }}"
                                   @change="fetch('{{ url_for('update_provider', provider_id=p.id) }}',
                                 {method:'POST',headers:{'Content-Type':'application/json'},
                                  body:JSON.stringify({weight:parseFloat($event.target.value)})})">
                        </td>
                        <td>
                            <div class="token-field">
                                <input :type="masked ? 'password' : 'text'" value="{{ p.api_token }}"
                                       @change="fetch('{{ url_for('update_provider', provider_id=p.id) }}',
                                     {method:'POST',headers:{'Content-Type':'application/json'},
                                      body:JSON.stringify({api_token:$event.target.value})})">
                                <button class="btn btn-small" type="button"
                                        @click="masked = !masked"
                                        x-text="masked ? 'Show' : 'Hide'">
                                </button>
                            </div>
                        </td>
                        <td class="col-enabled">
                            <input type="checkbox" {% if p.enabled %}checked{% endif %}
                                   @change="fetch('{{ url_for('update_provider', provider_id=p.id) }}',
                                 {method:'POST',headers:{'Content-Type':'application/json'},
                                  body:JSON.stringify({enabled:$event.target.checked})})">
                        </td>
                        <td class="nowrap">
                            <button class="btn btn-small danger"
                                    hx-post="{{ url_for('delete_provider', provider_id=p.id) }}"
                                    hx-swap="none"
                                    hx-on="htmx:afterRequest: location.reload()"
                                    hx-confirm="Are you sure to delete provider {{ p.provider_id }}">
                                Delete
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" class="muted">No providers found.</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>

            <details>
                <summary class="clickable">➕ Add model provider</summary>
                <form class="provider-form" onsubmit="return addProvider{{ m.id }}(event)">
                    <div class="panel">
                        <div class="token-field">
                            <label for="ptype-{{ m.id }}" class="chk">Provider:</label>
                            <select id="ptype-{{ m.id }}" class="col-api">
                                <option value="vllm">vllm</option>
                                <option value="openai">openai</option>
                                <option value="ollama">ollama</option>
                                <option value="ollama">llmstudio</option>
                            </select>
                            <input type="text" placeholder="Unique ID of provider for {{ m.name }}" id="pid-{{ m.id }}"
                                   class="col-input">
                        </div>

                        <div class="token-field">
                            <input type="url" placeholder="API host (e.g. https://api.example.com)"
                                   id="phost-{{ m.id }}" onchange="generateIdIfMissing{{ m.id }}()"
                                   required>
                            <select id="phostpreset-{{ m.id }}" class="col-api" onchange="setHost{{ m.id }}()">
                                <option value="">Custom</option>
                                <option value="https://api.openai.com">OpenAI</option>
                                <option value="https://generativelanguage.googleapis.com/v1beta2">Google OpenAI
                                    Compatible
                                </option>
                            </select>
                            <button type="button" class="btn btn-small" onclick="checkHost{{ m.id }}()">Check</button>
                        </div>

                        <span id="host-status-{{ m.id }}" class="muted"></span>

                        <div class="token-field" x-data="{ masked: true }">
                            <input :type="masked ? 'password' : 'text'"
                                   placeholder="API token (needed only when provider requires the API Key)"
                                   id="ptoken-{{ m.id }}" class="col-input">
                            <button class="btn btn-small" type="button" @click="masked = !masked"
                                    x-text="masked ? 'Show' : 'Hide'"></button>
                        </div>

                        <input type="text"
                               placeholder="Model path or name (optional - used to redirect to this model name)"
                               id="ppath-{{ m.id }}" class="col-input">

                        <label for="psize-{{ m.id }}" class="chk">input size:</label>
                        <input type="number" placeholder="Input size" id="psize-{{ m.id }}" value="4096" min="1"
                               class="col-input">


                        <label for="pweight-{{ m.id }}" class="chk">weight:</label>
                        <input type="number" step="0.01" min="0" max="1" placeholder="Weight (0‑1)"
                               id="pweight-{{ m.id }}" value="1.0" class="col-weight">

                        <label class="chk"><input type="checkbox" id="penabled-{{ m.id }}" checked> enabled</label>


                    </div>
                    <button class="btn btn-small" type="submit">Add</button>
                </form>
                <script>
                    async function addProvider{{ m.id }}(e){
                      e.preventDefault();
                      const payload = {
                        id: document.getElementById('pid-{{ m.id }}').value,
                        api_host: document.getElementById('phost-{{ m.id }}').value,
                        api_type: document.getElementById('ptype-{{ m.id }}').value,
                        input_size: parseInt(document.getElementById('psize-{{ m.id }}').value || "4096"),
                        model_path: document.getElementById('ppath-{{ m.id }}').value,
                        weight: parseFloat(document.getElementById('pweight-{{ m.id }}').value || "1.0"),
                        api_token: document.getElementById('ptoken-{{ m.id }}').value,
                        enabled: document.getElementById('penabled-{{ m.id }}').checked
                      };
                      const res = await fetch('{{ url_for("add_provider", model_id=m.id) }}', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                      });
                      if(res.ok){ location.reload(); } else { alert("Error while adding provider"); }
                    }

                    // Generates a provider ID from model name + host if ID field is empty
                    function generateIdIfMissing{{ m.id }}(){
                        const hostInput = document.getElementById('phost-{{ m.id }}');
                        const idInput = document.getElementById('pid-{{ m.id }}');
                        if (!idInput.value.trim()){
                            const modelName = "{{ m.name }}".replace(/[^a-zA-Z0-9]/g, '');
                            const hostPart = hostInput.value.replace(/^https?:\/\//, '').replace(/[^a-zA-Z0-9]/g, '');
                            if (modelName && hostPart){
                                idInput.value = `${modelName}_${hostPart}`;
                            }
                        }
                    }

                    // New helper – ustawia wartość hosta na podstawie wybranego preset’u
                    function setHost{{ m.id }}(){
                        const preset = document.getElementById('phostpreset-{{ m.id }}');
                        const hostInput = document.getElementById('phost-{{ m.id }}');
                        hostInput.value = preset.value;
                        generateIdIfMissing{{ m.id }}();
                    }

                    async function checkHost{{ m.id }}(){
                        const host = document.getElementById('phost-{{ m.id }}').value;
                        const statusEl = document.getElementById('host-status-{{ m.id }}');

                        if (!host) {
                            statusEl.textContent = 'Please enter a host URL first.';
                            statusEl.style.color = 'var(--danger)';
                            return;
                        }

                        statusEl.textContent = 'Checking...';
                        statusEl.style.color = 'var(--muted)';

                        try {
                            const resp = await fetch('{{ url_for("check_host") }}', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ url: host })
                            });

                            const data = await resp.json();

                            // If the request succeeded (i.e., the host responded), show OK.
                            // Any network error will be caught by the catch block below.
                            if (resp.ok || typeof data.status === 'number') {
                                statusEl.textContent = 'OK! Host is available!';
                                statusEl.style.color = 'var(--ok)';
                            } else {
                                // Unexpected situation – treat as error.
                                const errMsg = data.error || 'Unable to reach the host.';
                                statusEl.textContent = errMsg;
                                statusEl.style.color = 'var(--danger)';
                            }
                        } catch (e) {
                            console.error(e);
                            statusEl.textContent = 'Unable to reach the host. Check the URL or server connectivity.';
                            statusEl.style.color = 'var(--danger)';
                        }
                    }
                </script>
            </details>
        </details>
        <hr class="model-divider">
        {% else %}
        <p class="muted">No models found.</p>
        {% endfor %}
    </section>
    {% endfor %}
</div>

<div class="actions">
    <a class="btn" href="{{ url_for('export_config', config_id=cfg.id) }}">Export config</a>
    <button class="btn" hx-post="{{ url_for('set_active_config', config_id=cfg.id) }}" hx-swap="none">Set as default
    </button>
    <a class="btn btn-secondary" href="{{ url_for('view_config', config_id=cfg.id) }}">Preview</a>
</div>

<hr class="model-divider">

<h3>History</h3>

<div id="history-wrapper">
    <div hx-get="{{ url_for('list_versions', config_id=cfg.id) }}"
         hx-trigger="load"
         hx-target="#versions"
         hx-swap="innerHTML">
    </div>
    <table class="table" id="versions"></table>
</div>

<button class="btn btn-small" id="toggle-history" style="display:none;">
    Show full history
</button>

<script>
    document.body.addEventListener('htmx:afterOnLoad', function (e) {
        if (!e.detail.target || e.detail.target.id !== 'versions') return;

        let data;
        try {
            data = JSON.parse(e.detail.xhr.responseText);
        } catch (err) {
            console.error('Failed to parse versions JSON', err);
            return;
        }

        const configId = {{ cfg.id }};

        const rows = data.map(v => `
            <tr>
                <td>v${v.version}</td>
                <td>${new Date(v.created_at).toLocaleString()}</td>
                <td>${v.note || ''}</td>
                <td>
                    <button class="btn btn-small"
                            hx-post="/configs/${configId}/versions/${v.version}/restore"
                            hx-trigger="click"
                            hx-swap="none"
                            hx-on="htmx:afterRequest: location.reload()">Restore</button>
                </td>
            </tr>`).join('');

        e.detail.target.innerHTML = `
            <thead>
                <tr>
                    <th>Version</th>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>${rows}</tbody>`;

        if (typeof htmx !== 'undefined') {
            htmx.process(e.detail.target);
        }

        const tbody = e.detail.target.querySelector('tbody');
        const trList = tbody.querySelectorAll('tr');

        const btn = document.getElementById('toggle-history');

        if (trList.length <= 1) {
            btn.style.display = 'none';
            return;
        }

        for (let i = 1; i < trList.length; i++) {
            trList[i].style.display = 'none';
        }

        btn.style.display = 'inline-block';
        btn.textContent = 'Show full history';

        btn.onclick = function () {
            const showAll = btn.textContent.startsWith('Show');
            for (let i = 1; i < trList.length; i++) {
                trList[i].style.display = showAll ? '' : 'none';
            }
            btn.textContent = showAll ? 'Hide history' : 'Show full history';
        };
    });

    document.addEventListener('DOMContentLoaded', function () {
        function enableDnD(tbody) {
            let dragSrc = null;

            tbody.addEventListener('dragstart', function (e) {
                const tr = e.target.closest('tr[data-provider-id]');
                if (!tr) return;
                dragSrc = tr;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', tr.dataset.providerId);
            });

            tbody.addEventListener('dragover', function (e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });

            tbody.addEventListener('drop', function (e) {
                e.preventDefault();
                const targetTr = e.target.closest('tr[data-provider-id]');
                if (!targetTr || targetTr === dragSrc) return;

                if (dragSrc.rowIndex < targetTr.rowIndex) {
                    targetTr.after(dragSrc);
                } else {
                    targetTr.before(dragSrc);
                }
                const rows = Array.from(tbody.querySelectorAll('tr[data-provider-id]'));
                const newOrder = rows.map(r => parseInt(r.dataset.providerId));

                const modelId = tbody.dataset.modelId;
                fetch(`/models/${modelId}/providers/reorder`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order: newOrder })
                })
                    .then(r => r.json())
                    .then(data => {
                        if (!data.ok) {
                            alert('Failed to save new order');
                        }
                    })
                    .catch(() => alert('Network error while reordering'));
            });
        }

        document.querySelectorAll('tbody[data-model-id]').forEach(enableDnD);
    });
</script>

{% endblock %}